#!/bin/bash

# Apply theme to generate config files in ~/.dots/.config/theme/
# Usage: dots-theme-apply <theme-name>

DOTS="$HOME/.dots"
THEME_DIR="$DOTS/extra/themes"
SOURCE_DIR="$DOTS/extra/source/templates"
OUTPUT_DIR="$DOTS/.config/theme"

if [[ -z $1 ]]; then
  echo "Usage: $0 <theme-name>"
  exit 1
fi

THEME_NAME=$(echo "$1" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
THEME_PATH="$THEME_DIR/$THEME_NAME"

if [[ ! -d $THEME_PATH ]]; then
  echo "Theme '$THEME_NAME' does not exist in $THEME_DIR"
  exit 1
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Copy theme files first
cp -r "$THEME_PATH/"* "$OUTPUT_DIR/" 2>/dev/null

# Generate configs from templates
DOTS_THEME_DIR="$OUTPUT_DIR" DOTS_SOURCE_DIR="$SOURCE_DIR" "$DOTS/extra/bin/omarchy-theme-set-templates"

# Restart components
if pgrep -x waybar >/dev/null; then
  waybarctl reload 2>/dev/null || pkill -HUP waybar
fi

if pgrep -x hyprlock >/dev/null; then
  pkill -RUSTERM hyprlock
fi

if pgrep -x kitty >/dev/null; then
  pkill -USR1 kitty
fi

if pgrep -x mako >/dev/null; then
  pkill -HUP mako
fi

if pgrep -x btop >/dev/null; then
  btop --reload
fi

echo "Theme '$THEME_NAME' applied successfully"
