#!/bin/bash

# Generate config files from templates using theme colors
# Called by dots-theme-apply

DOTS="$HOME/.dots"
TEMPLATE_DIR="${DOTS_SOURCE_DIR:-$DOTS/extra/source/templates}"
OUTPUT_DIR="${DOTS_THEME_DIR:-$DOTS/.config/theme}"
COLORS_FILE="$OUTPUT_DIR/colors.toml"

# Convert hex color to decimal RGB (e.g., "#1e1e2e" -> "30,30,46")
hex_to_rgb() {
  local hex="${1#\#}"
  printf "%d,%d,%d" "0x${hex:0:2}" "0x${hex:2:2}" "0x${hex:4:2}"
}

# Only generate dynamic templates for themes with a colors.toml definition
if [[ -f $COLORS_FILE ]]; then
  sed_script=$(mktemp)

  while IFS='=' read -r key value; do
    key="${key//[\"\' ]/}"                # strip quotes and spaces from key
    [[ $key && $key != \#* ]] || continue # skip empty lines and comments
    value="${value#*[\"\']}"
    value="${value%%[\"\']*}" # extract value between quotes (ignores inline comments)

    printf 's|{{ %s }}|%s|g\n' "$key" "$value"            # {{ key }} -> value
    printf 's|{{ %s_strip }}|%s|g\n' "$key" "${value#\#}" # {{ key_strip }} -> value without leading #
    if [[ $value =~ ^# ]]; then
      rgb=$(hex_to_rgb "$value")
      echo "s|{{ ${key}_rgb }}|${rgb}|g"
    fi
  done <"$COLORS_FILE" >"$sed_script"

  shopt -s nullglob

  # Process templates
  for tpl in "$TEMPLATE_DIR"/*.tpl; do
    filename=$(basename "$tpl" .tpl)
    output_path="$OUTPUT_DIR/$filename"

    # Don't overwrite configs already in the output directory (copied from theme folder)
    if [[ ! -f $output_path ]]; then
      sed -f "$sed_script" "$tpl" >"$output_path"
    fi
  done

  rm "$sed_script"
fi
